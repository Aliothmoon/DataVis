<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <title>Framework</title>
    <script type='text/javascript' src='../../Resources/lib/d3.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"
            integrity="sha512-M7nHCiNUOwFt6Us3r8alutZLm9qMt4s9951uo8jqO4UwJ1hziseL6O3ndFyigx6+LREfZqnhHxYjKRJ8ZQ69DQ=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>

<body>
<svg width='1200px' height='800px'></svg>
<script type='text/javascript'>
    d3.csv('./1.csv')
        .then(data => {
            // Calculate average score for each problem
            let problemScores = {};
            let problemCounts = {};
            data.forEach(d => {
                if (!problemScores[d.problemId]) {
                    problemScores[d.problemId] = 0;
                    problemCounts[d.problemId] = 0;
                }
                problemScores[d.problemId] += d.errorMessage ? 0 : 100;
                problemCounts[d.problemId]++;
            });
            let avgScores = Object.keys(problemScores).map(id => ({
                problemId: id,
                avgScore: problemScores[id] / problemCounts[id]
            }));

            const svg = d3.select('svg')
            const width = 928;
            const height = 500;
            const marginTop = 30;
            const marginRight = 0;
            const marginBottom = 30;
            const marginLeft = 40;

            // Declare the x (horizontal position) scale.
            const x = d3.scaleBand()
                .domain(avgScores.map(d => d.problemId))
                .range([marginLeft, width - marginRight])
                .padding(0.1);

            // Declare the y (vertical position) scale.
            const y = d3.scaleLinear()
                .domain([0, d3.max(avgScores, d => d.avgScore)])
                .range([height - marginBottom, marginTop]);

            // Create the SVG container.
            svg.attr("width", width)
                .attr("height", height)
                .attr("viewBox", [0, 0, width, height])
                .attr("style", "max-width: 100%; height: auto;");

            // Add a rect for each bar.
            svg.append("g")
                .attr("fill", "steelblue")
                .selectAll()
                .data(avgScores)
                .join("rect")
                .attr("x", d => x(d.problemId))
                .attr("y", d => y(d.avgScore))
                .attr("height", d => y(0) - y(d.avgScore))
                .attr("width", x.bandwidth());

            // Add the x-axis and label.
            svg.append("g")
                .attr("transform", `translate(0,${height - marginBottom})`)
                .call(d3.axisBottom(x).tickSizeOuter(0))
                .call(g => g.selectAll(".tick text")
                    .attr("display", (_, i) => i % 10 === 0 ? null : "none"));  // Only display every 10th label

            // Add the y-axis and label, and remove the domain line.
            svg.append("g")
                .attr("transform", `translate(${marginLeft},0)`)
                .call(d3.axisLeft(y).tickFormat(y => y.toFixed(2)))
                .call(g => g.select(".domain").remove())
                .call(g => g.append("text")
                    .attr("x", -marginLeft)
                    .attr("y", 10)
                    .attr("fill", "currentColor")
                    .attr("text-anchor", "start")
                    .text("â†‘ Average Score"));

            // Return the SVG element.
            return svg.node();
        })
</script>
</body>

</html>
